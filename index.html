<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>2048 — Folder Images (with Global Leaderboard)</title>
  <style>
    body{margin:0;font-family:sans-serif;background:#faf8ef;display:flex;flex-direction:column;justify-content:center;align-items:center;min-height:100vh}

    #hud{display:flex;flex-direction:column;align-items:center;gap:8px;margin-bottom:10px;color:#776e65}
    #scoreboard{display:flex;gap:18px;flex-wrap:wrap;justify-content:center}
    .badge{background:#eee4da;border-radius:10px;padding:8px 12px;font-weight:600}

    #leaderWrap{display:grid;grid-template-columns:1fr;gap:8px;justify-items:center;margin-bottom:10px}
    #leaderboard{width:340px;max-width:92vw;background:#eee4da;border-radius:10px;padding:10px}
    #leaderboard h3,#personalBest h3{margin:0 0 8px 0;font-size:16px;color:#776e65;text-align:center}
    #leaderboard ol{margin:0;padding-left:20px}
    #leaderboard li{margin:4px 0}
    #personalBest{width:340px;max-width:92vw;background:#eee4da;border-radius:10px;padding:10px}

    #board{display:grid;grid-template-columns:repeat(4,100px);grid-gap:10px;background:#bbada0;padding:10px;border-radius:10px;position:relative}
    .cell{width:100px;height:100px;background:#cdc1b4;border-radius:5px;position:relative;overflow:hidden}
    .tile{position:absolute;inset:0;display:flex;justify-content:center;align-items:center;font-size:20px;font-weight:bold;color:#fff;border-radius:5px;text-align:center;box-sizing:border-box;padding:0}
    .tile img{width:100%;height:100%;object-fit:cover;border-radius:5px;display:block}

    .watermark{margin-top:15px;font-size:14px;color:#776e65;opacity:0.7;user-select:none;text-align:center;width:100%;}
    .watermark span.star{font-size:14px;color:#776e65;margin-left:2px}

    #passwordPrompt{display:flex;flex-direction:column;justify-content:center;align-items:center;min-height:100vh;background:#faf8ef}
    #passwordPrompt input{padding:8px;font-size:16px;margin-top:10px}
    #passwordPrompt button{margin-top:10px;padding:8px 16px;font-size:16px;cursor:pointer}

    #gameOverOverlay{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(238,228,218,0.8);display:flex;justify-content:center;align-items:center;flex-direction:column;font-size:32px;color:#776e65;font-weight:bold;border-radius:10px;z-index:10}
    #gameOverOverlay button{margin-top:20px;padding:10px 20px;font-size:18px;cursor:pointer}
  </style>
</head>
<body>
  <!-- PASSWORD GATE -->
  <div id="passwordPrompt">
    <h2>Enter Password to Play</h2>
    <form id="pwForm" style="display:flex;flex-direction:column;align-items:center;gap:10px;">
      <input type="password" id="passwordInput" placeholder="Password" autofocus>
      <button id="passwordBtn" type="submit">Submit</button>
    </form>
    <p id="error" style="color:red;display:none;">Incorrect password</p>
  </div>

  <!-- GAME CONTAINER -->
  <div id="gameContainer" style="display:none;">
    <div id="hud">
      <div id="scoreboard">
        <div class="badge">Your current score: <span id="currentScore">Gabe</span></div>
        <div class="badge">Your high score: <span id="highScore">Gabe</span></div>
      </div>
      <div id="leaderWrap">
        <div id="leaderboard">
          <h3>All‑time Top 5</h3>
          <ol id="leaderList"></ol>
        </div>
        <div id="personalBest">
          <h3>Your Personal Best</h3>
          <div id="personalBestLine">Best: Gabe</div>
          <div id="yourRankLine" style="margin-top:4px;">Not on the board yet.</div>
        </div>
      </div>
    </div>

    <div id="board"></div>
    <div id="gameOverOverlay" style="display:none;">
      <div>Game Over</div>
      <button onclick="restartGame()">Restart</button>
    </div>
    <div class="watermark">AdyrStudios <span class="star">✡</span></div>
  </div>

  <!-- FIREBASE (GLOBAL LEADERBOARD) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
  apiKey: "AIzaSyBDmxc9cg894mr6k2qD0CNmlcm7xqIM-1E",
  authDomain: "mac2048-e8ae1.firebaseapp.com",
  projectId: "mac2048-e8ae1",
  storageBucket: "mac2048-e8ae1.firebasestorage.app",
  messagingSenderId: "539725048583",
  appId: "1:539725048583:web:32788c5135fc8172f4f3a2"
};

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    const ready = signInAnonymously(auth).catch(console.error);
    async function fetchTop5(){ await ready; const q=query(collection(db,'leaderboard'), orderBy('tile','desc'), limit(5)); const snap=await getDocs(q); return snap.docs.map(d=>d.data()); }
    async function submitTopScore(name, tile){ await ready; await addDoc(collection(db,'leaderboard'), {name, tile, ts: serverTimestamp()}); }
    window.firebaseAPIs = { fetchTop5, submitTopScore, ready };
  </script>

  <!-- GAME LOGIC -->
  <script>
    // ======== Config / Maps ========
    const SIZE=4;
    const nameMap={2:"Gabe",4:"Hannah",8:"Adam Taylor",16:"Lex",32:"Kate",64:"Adyr",128:"Brooke",256:"Ben Lightstone",512:"Linoy",1024:"Adam Storger",2048:"Stewie"};
    const imageMap={2:"images/2.png",4:"images/4.png",8:"images/8.png",16:"images/16.png",32:"images/32.png",64:"images/64.png",128:"images/128.png",256:"images/256.png",512:"images/512.png",1024:"images/1024.png",2048:"images/2048.png"};
    const LS_KEYS={NAME:"playerName_v1", PB:"personalBestMax_v1"};

    // ======== State ========
    let grid;           // 4x4 matrix of numbers
    let currentMax=2;   // highest tile in current run

    // ======== Storage helpers ========
    function loadJSON(key, def){try{const s=localStorage.getItem(key);return s?JSON.parse(s):def;}catch(e){return def;}}
    function saveJSON(key,val){try{localStorage.setItem(key, JSON.stringify(val));}catch(e){}}

    function getPlayerName(){
      let n=loadJSON(LS_KEYS.NAME, null);
      if(!n){ const m=document.cookie.match(/playerName_v1=([^;]+)/); if(m) n=decodeURIComponent(m[1]); }
      return n;
    }
    function setPlayerName(n){ saveJSON(LS_KEYS.NAME, n); document.cookie=`playerName_v1=${encodeURIComponent(n)};path=/;max-age=${60*60*24*365*5}`; }

    function getPersonalBest(){ return loadJSON(LS_KEYS.PB, 2); }
    function setPersonalBest(v){ saveJSON(LS_KEYS.PB, v); }

    function formatTile(v){ return nameMap[v]||String(v); }

    // ======== Core grid helpers ========
    function createEmpty(){return Array.from({length:SIZE},()=>Array(SIZE).fill(0));}
    function addRandom(){ const empty=[]; for(let r=0;r<SIZE;r++) for(let c=0;c<SIZE;c++) if(!grid[r][c]) empty.push([r,c]); if(!empty.length) return; const [r,c]=empty[Math.floor(Math.random()*empty.length)]; grid[r][c] = Math.random()<0.9?2:4; }

    const board=document.getElementById('board');

    function setupBoard(){
      board.innerHTML='';
      for(let i=0;i<SIZE*SIZE;i++){ const cell=document.createElement('div'); cell.className='cell'; board.appendChild(cell); }
    }

    function draw(){
      // reset and scan current max each draw
      currentMax = 2;
      board.querySelectorAll('.tile').forEach(t=>t.remove());
      const cells=board.querySelectorAll('.cell');
      for(let r=0;r<SIZE;r++) for(let c=0;c<SIZE;c++){
        const v=grid[r][c]; if(!v) continue;
        const tile=document.createElement('div'); tile.className='tile';
        if(imageMap[v]){ const img=document.createElement('img'); img.src=imageMap[v]; tile.appendChild(img);} else { tile.textContent=v; tile.style.background='#edc22e'; }
        cells[r*SIZE+c].appendChild(tile);
        if(v>currentMax) currentMax=v;
      }
      // scoreboard (current = run max, high = personal best)
      document.getElementById('currentScore').textContent = formatTile(currentMax);
      document.getElementById('highScore').textContent    = formatTile(getPersonalBest());
    }

    function compress(row){ return row.filter(x=>x); }
    function pad(row){ while(row.length<SIZE) row.push(0); return row; }

    function move(dir){
      let moved=false;
      if(dir==='left'||dir==='right'){
        for(let r=0;r<SIZE;r++){
          let row=grid[r].slice();
          if(dir==='right') row.reverse();
          row=compress(row);
          for(let i=0;i<row.length-1;i++) if(row[i] && row[i]===row[i+1]){ row[i]*=2; row[i+1]=0; i++; }
          row=pad(compress(row));
          if(dir==='right') row.reverse();
          if(row.some((v,i)=>v!==grid[r][i])) moved=true;
          grid[r]=row;
        }
      } else {
        for(let c=0;c<SIZE;c++){
          let col=grid.map(r=>r[c]);
          if(dir==='down') col.reverse();
          col=compress(col);
          for(let i=0;i<col.length-1;i++) if(col[i] && col[i]===col[i+1]){ col[i]*=2; col[i+1]=0; i++; }
          col=pad(compress(col));
          if(dir==='down') col.reverse();
          for(let r=0;r<SIZE;r++){ if(grid[r][c]!==col[r]) moved=true; grid[r][c]=col[r]; }
        }
      }
      if(moved) addRandom();
      draw();
      if(checkGameOver()) showGameOver();
    }

    function checkGameOver(){
      for(let r=0;r<SIZE;r++) for(let c=0;c<SIZE;c++) if(grid[r][c]===0) return false;
      for(let r=0;r<SIZE;r++) for(let c=0;c<SIZE-1;c++) if(grid[r][c]===grid[r][c+1]) return false;
      for(let c=0;c<SIZE;c++) for(let r=0;r<SIZE-1;r++) if(grid[r][c]===grid[r+1][c]) return false;
      return true;
    }

    function showGameOver(){
      document.getElementById('gameOverOverlay').style.display='flex';
      handleScores();
    }

    function restartGame(){
      document.getElementById('gameOverOverlay').style.display='none';
      startGame();
    }

    // ======== Leaderboard / Personal Best ========
    async function handleScores(){
      // update personal best locally
      const prevPB = getPersonalBest();
      if(currentMax > prevPB){ setPersonalBest(currentMax); }

      // try to pull board; if failure, fall back to empty so user can still be prompted
      const apis = window.firebaseAPIs;
      if(!apis){ renderLeaderboard([]); return; }

      (async () => {
        let top5 = [];
        try { await apis.ready; top5 = await apis.fetchTop5(); } catch(e) { top5 = []; }

        const minTop = top5.length ? Math.min(...top5.map(e=>e.tile)) : 0;
        const qualifies = top5.length < 5 || currentMax > minTop;
        if(qualifies){
          let name = getPlayerName();
          if(!name){
            name = prompt('Congrats! New Top 5 score. Enter your name:') || 'Player';
            setPlayerName(name);
          }
          try { await apis.submitTopScore(name, currentMax); } catch(e) { console.warn('Submit failed:', e); }
        }

        try { top5 = await apis.fetchTop5(); } catch(e) { /* keep prior */ }
        renderLeaderboard(top5);
      })();
    }

    async function renderLeaderboard(top){(top){
      // if not provided, fetch
      if(!top){
        try{ top = await window.firebaseAPIs.fetchTop5(); } catch{ top=[]; }
      }
      const list = document.getElementById('leaderList');
      list.innerHTML='';
      top.forEach(e=>{
        const li=document.createElement('li');
        li.textContent = `${e.name}: ${formatTile(e.tile)}`;
        list.appendChild(li);
      });

      // personal best and rank line
      const pb = getPersonalBest();
      document.getElementById('personalBestLine').textContent = `Best: ${formatTile(pb)}`;

      const myName = getPlayerName();
      let rankLine='Not on the board yet.';
      if(myName && top.length){
        const bestForMe = Math.max(...top.filter(x=>x.name===myName).map(x=>x.tile), 0);
        const idx = top.findIndex(e=>e.tile===bestForMe && e.name===myName);
        if(idx>-1) rankLine = `You are #${idx+1} on the leaderboard.`;
      }
      document.getElementById('yourRankLine').textContent = rankLine;

      // also keep scoreboard high score in sync with personal best
      document.getElementById('highScore').textContent = formatTile(pb);
    }

    // ======== Password & Boot ========
    window.checkPassword = function checkPassword(){
      try{
        const inputEl=document.getElementById('passwordInput');
        const val=(inputEl.value||'').trim();
        if(val==='mcjewish'){
          document.getElementById('passwordPrompt').style.display='none';
          document.getElementById('gameContainer').style.display='block';
          startGame();
        } else {
          const err=document.getElementById('error');
          err.style.display='block';
          inputEl.style.outline='2px solid #d33';
          setTimeout(()=>inputEl.style.outline='none',300);
        }
      }catch(e){
        alert('Error initializing game. Open the console for details.');
        console.error(e);
      }
    }

    // attach listeners after DOM is ready
    (function(){
      const form=document.getElementById('pwForm');
      const pw=document.getElementById('passwordInput');
      if(form){
        form.addEventListener('submit', (e)=>{ e.preventDefault(); window.checkPassword(); });
      }
      if(pw){
        pw.addEventListener('keydown',e=>{ if(e.key==='Enter'){ /* handled by form submit */ }});
      }
    })();

    function startGame(){
      const inputEl=document.getElementById('passwordInput');
      const val=(inputEl.value||'').trim();
      if(val==='mcjewish'){
        document.getElementById('passwordPrompt').style.display='none';
        document.getElementById('gameContainer').style.display='block';
        startGame();
      } else {
        const err=document.getElementById('error');
        err.style.display='block';
        // little visual cue
        inputEl.style.outline='2px solid #d33';
        setTimeout(()=>inputEl.style.outline='none',300);
      }
    }

    // allow pressing Enter to submit password
    (function(){
      const pw=document.getElementById('passwordInput');
      if(pw){
        pw.addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); checkPassword(); }});
      }
    })();

    function startGame(){
      grid=createEmpty();
      setupBoard();
      addRandom(); addRandom();
      draw();
      // draw leaderboard (no write)
      if(window.firebaseAPIs){ window.firebaseAPIs.fetchTop5().then(renderLeaderboard).catch(()=>renderLeaderboard([])); }
      // single key handler
      window.onkeydown = (e)=>{
        if(e.key==='ArrowLeft') move('left');
        if(e.key==='ArrowRight') move('right');
        if(e.key==='ArrowUp') move('up');
        if(e.key==='ArrowDown') move('down');
      };
    }
  </script>
</body>
</html>
